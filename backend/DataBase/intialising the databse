# initialize_db.py

import sqlite3

DB_FILE = "backend/DataBase/database.db"

def create_database():
    
    conn = None  
    try:
        
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        print("Successfully connected to SQLite database.")

        
        cursor.execute("PRAGMA foreign_keys = ON;")

        print("Creating tables...")

        # --- SQL statement for Users table ---
        sql_create_users_table = """
        CREATE TABLE IF NOT EXISTS Users (
            user_id TEXT PRIMARY KEY,
            email TEXT UNIQUE NOT NULL,
            hashed_password TEXT NOT NULL,
            full_name TEXT NOT NULL,
            role TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        """

        # --- SQL statement for Cases table ---
        sql_create_cases_table = """
        CREATE TABLE IF NOT EXISTS Cases (
            case_id TEXT PRIMARY KEY,
            case_name TEXT NOT NULL,
            status TEXT NOT NULL DEFAULT 'Open',
            creator_id TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (creator_id) REFERENCES Users (user_id)
        );
        """

        # --- SQL statement for Documents table ---
        sql_create_documents_table = """
        CREATE TABLE IF NOT EXISTS Documents (
            doc_id TEXT PRIMARY KEY,
            case_id TEXT NOT NULL,
            uploader_id TEXT NOT NULL,
            file_name TEXT NOT NULL,
            storage_path TEXT UNIQUE NOT NULL,
            uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (case_id) REFERENCES Cases (case_id),
            FOREIGN KEY (uploader_id) REFERENCES Users (user_id)
        );
        """

        # --- SQL statement for DocumentPermissions table ---
        # INTEGER PRIMARY KEY AUTOINCREMENT is the standard SQLite way for an auto-incrementing ID.
        sql_create_permissions_table = """
        CREATE TABLE IF NOT EXISTS DocumentPermissions (
            permission_id INTEGER PRIMARY KEY AUTOINCREMENT,
            doc_id TEXT NOT NULL,
            user_id TEXT NOT NULL,
            FOREIGN KEY (doc_id) REFERENCES Documents (doc_id) ON DELETE CASCADE,
            FOREIGN KEY (user_id) REFERENCES Users (user_id) ON DELETE CASCADE,
            UNIQUE (doc_id, user_id)
        );
        """
        
        # Execute the SQL statements
        cursor.execute(sql_create_users_table)
        cursor.execute(sql_create_cases_table)
        cursor.execute(sql_create_documents_table)
        cursor.execute(sql_create_permissions_table)
        
        # Commit the changes to the database
        conn.commit()
        print("Tables created successfully.")

    except sqlite3.Error as e:
        print(f"Database error: {e}")
    finally:
        # Ensure the connection is closed
        if conn:
            conn.close()
            print("SQLite connection is closed.")

if __name__ == '__main__':
    create_database()